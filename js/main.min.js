/*!
 * Milk - 2014-12-21
 * Stanislav Nekrasov | to@exwar.com     
 */
$W = $(window), $D = $(document), $H = $("html"), $B = $("body");

var MakeMap = function(a) {
    var b = $.extend({}, this.defaults, a), c = new $.Deferred(), d = null, e = {
        center: null,
        zoom: b.zoom,
        disableDefaultUI: !0,
        scrollwheel: !1,
        styles: b.styles
    };
    return this.checkGMapsLoad().done(function() {
        e.center = new google.maps.LatLng(b.center[0], b.center[1]), d = new google.maps.Map(b.el.get(0), e), 
        b.el.data("map", d), c.resolve();
    }), c;
};

MakeMap.prototype = {
    constructor: MakeMap,
    isLibLoaded: new $.Deferred(),
    checkGMapsLoad: function() {
        var a = this;
        return "google" in window ? a.isLibLoaded.resolve() : setTimeout(function() {
            a.checkGMapsLoad();
        }, 500), a.isLibLoaded;
    },
    defaults: {
        center: [ 55.755826, 37.6173 ],
        zoom: 11,
        styles: [ {
            featureType: "poi",
            elementType: "labels",
            stylers: [ {
                visibility: "off"
            } ]
        }, {
            featureType: "water",
            elementType: "labels",
            stylers: [ {
                visibility: "off"
            } ]
        }, {
            featureType: "water",
            elementType: "geometry",
            stylers: [ {
                visibility: "simplified"
            }, {
                hue: "#0091ff"
            }, {
                saturation: 17
            }, {
                gamma: .74
            }, {
                lightness: -8
            } ]
        }, {
            featureType: "administrative.locality",
            elementType: "labels.text",
            stylers: [ {
                visibility: "off"
            } ]
        }, {
            featureType: "transit.station.rail",
            elementType: "labels.text.fill",
            stylers: [ {
                weight: .1
            }, {
                invert_lightness: !0
            }, {
                visibility: "on"
            }, {
                color: "#877673"
            }, {
                hue: "#ff0000"
            }, {
                saturation: -30
            }, {
                lightness: 16
            }, {
                gamma: .78
            } ]
        }, {
            stylers: [ {
                gamma: 1.18
            }, {
                saturation: 4
            }, {
                lightness: 4
            } ]
        } ]
    }
}, $(function() {
    !function() {
        function a() {
            var a = 1e3;
            Modernizr.mq("screen and (min-width: 1300px)") && (a = 1300), Modernizr.mq("screen and (min-width: 1600px)") && (a = 1600), 
            a !== b && (b = a, $D.trigger({
                type: "window:changemq",
                mqPoint: a
            }));
        }
        var b = 0;
        $D.on("checkmq", a), $W.on("resize", $.debounce(300, a));
    }(), function() {
        var a = $(".start-page");
        a.each(function() {
            var a = $(this);
            a.parallax({
                calibrateX: !0,
                calibrateY: !0,
                limitX: 50,
                limitY: !0,
                scalarY: !1
            });
        });
    }(), function() {
        var a = $(".js-fullheight");
        a.each(function() {
            function a() {
                var a = $W.height() - c.footerHeight;
                620 > a && (a = 620), b.height(a / 10 + "rem"), c.isReady || (c.isReady = !0, b.addClass("_ready"));
            }
            var b = $(this), c = {
                footerHeight: 60,
                isReady: !1
            };
            $W.on("resize", a).trigger("resize");
        });
    }(), function() {
        function a() {
            var a = $(this), b = a.closest(".js-marker");
            b.length && b.toggleClass("_active");
        }
        $D.on("click", ".js-marker-close, .js-marker-image", a);
    }(), function() {
        var a = $(".js-market-map");
        a.each(function() {
            function a() {
                i.panTo(k.center), i.setZoom(k.zoom);
            }
            function b() {
                j = new google.maps.LatLngBounds(), $.each(g, function(a, b) {
                    {
                        var c = h.replace("{{ title }}", b.title).replace("{{ content }}", b.content).replace("{{ coords }}", b.coords.join(";")), d = new google.maps.LatLng(b.coords[0], b.coords[1]);
                        new RichMarker({
                            map: i,
                            position: d,
                            draggable: !1,
                            flat: !0,
                            content: c,
                            enableEventPropagation: !0
                        });
                    }
                }), f.mapObject.on("click", ".js-marker-image", function() {
                    var a = $(this), b = a.closest(".js-marker"), c = b.data("coords").split(";"), d = new google.maps.LatLng(c[0], c[1]);
                    f.mapObject.find(".js-marker").not(b).removeClass("_active"), i.panTo(d), i.setZoom(l);
                }).on("click", ".js-marker-close", a);
            }
            function c() {
                function a() {
                    var a = i.getZoom(), e = b.filter("._in"), f = b.filter("._out");
                    b.removeClass("_disabled"), a == d && e.addClass("_disabled"), a == c && f.addClass("_disabled");
                }
                var b = f.zoom.find(".js-map-zoom-button"), c = ~~f.mapObject.data("zoomMin") || 6, d = ~~f.mapObject.data("zoomMax") || 18;
                b.on("click", function() {
                    var a = $(this), b = a.hasClass("_out") ? -1 : 1, c = i.getZoom(), d = c + b;
                    a.hasClass("_disabled") || i.setZoom(d);
                }), google.maps.event.addListener(i, "zoom_changed", a);
            }
            function d() {
                i = f.mapObject.data("map"), k.center = i.getCenter(), k.zoom = i.getZoom(), setTimeout(function() {
                    $(i.getDiv()).find("> DIV").addClass("gm-map-holder");
                }, 100), b(), c(), $W.on("resize", function() {
                    var a = i.getZoom(), b = i.getCenter();
                    google.maps.event.trigger(i, "resize"), i.setZoom(a), i.setCenter(b);
                });
            }
            var e = $(this), f = {
                mapObject: $(".js-market-map-object", e),
                markerTPL: $(".js-market-map-markertpl", e),
                zoom: $(".js-map-zoom", e)
            }, g = window.G.market.points || [], h = f.markerTPL.html(), i = null, j = null, k = {}, l = 16;
            if (!Modernizr.flexbox) {
                var m = null;
                f.mapObject.append('<div class="market-map-ie"><div class="market-map-ie__nest"></div></div>'), 
                m = f.mapObject.find(".market-map-ie__nest"), m.data(f.mapObject.data()), f.mapObject = m;
            }
            new MakeMap({
                el: f.mapObject,
                zoom: 9
            }).done(d);
        });
    }();
});