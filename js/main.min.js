/*!
 * Iskrennevash - 2014-12-25
 * Stanislav Nekrasov | to@exwar.com     
 */
$W = $(window), $D = $(document), $H = $("html"), $B = $("body");

var MakeMap = function(a) {
    var b = $.extend({}, this.defaults, a), c = new $.Deferred(), d = null, e = {
        center: null,
        zoom: b.zoom,
        disableDefaultUI: !0,
        scrollwheel: !1,
        styles: b.styles
    };
    return this.checkGMapsLoad().done(function() {
        e.center = new google.maps.LatLng(b.center[0], b.center[1]), d = new google.maps.Map(b.el.get(0), e), 
        b.el.data("map", d), c.resolve();
    }), c;
};

MakeMap.prototype = {
    constructor: MakeMap,
    isLibLoaded: new $.Deferred(),
    checkGMapsLoad: function() {
        var a = this;
        return "google" in window ? a.isLibLoaded.resolve() : setTimeout(function() {
            a.checkGMapsLoad();
        }, 500), a.isLibLoaded;
    },
    defaults: {
        center: [ 55.755826, 37.6173 ],
        zoom: 11,
        styles: [ {
            featureType: "poi",
            elementType: "labels",
            stylers: [ {
                visibility: "off"
            } ]
        }, {
            featureType: "water",
            elementType: "labels",
            stylers: [ {
                visibility: "off"
            } ]
        }, {
            featureType: "water",
            elementType: "geometry",
            stylers: [ {
                visibility: "simplified"
            }, {
                hue: "#0091ff"
            }, {
                saturation: 17
            }, {
                gamma: .74
            }, {
                lightness: -8
            } ]
        }, {
            featureType: "administrative.locality",
            elementType: "labels.text",
            stylers: [ {
                visibility: "off"
            } ]
        }, {
            featureType: "transit.station.rail",
            elementType: "labels.text.fill",
            stylers: [ {
                weight: .1
            }, {
                invert_lightness: !0
            }, {
                visibility: "on"
            }, {
                color: "#877673"
            }, {
                hue: "#ff0000"
            }, {
                saturation: -30
            }, {
                lightness: 16
            }, {
                gamma: .78
            } ]
        }, {
            stylers: [ {
                gamma: 1.18
            }, {
                saturation: 4
            }, {
                lightness: 4
            } ]
        } ]
    }
}, $(function() {
    !function() {
        function a() {
            var a = 1e3;
            Modernizr.mq("screen and (min-width: 1300px)") && (a = 1300), Modernizr.mq("screen and (min-width: 1600px)") && (a = 1600), 
            a !== b && (b = a, $D.trigger({
                type: "window:changemq",
                mqPoint: a
            }));
        }
        var b = 0;
        $D.on("checkmq", a), $W.on("resize", $.debounce(300, a));
    }(), function() {
        var a = $(".start-page");
        a.each(function() {
            var a = $(this);
            a.parallax({
                calibrateX: !0,
                calibrateY: !0,
                limitX: 50,
                limitY: !0,
                scalarY: !1
            });
        });
    }(), function() {
        var a = $(".js-descbox");
        a.each(function() {
            function a(a) {
                var d = c.more.text();
                a.preventDefault(), c.part.slideToggle(500, function() {
                    b.trigger({
                        type: "descbox:toggle:end"
                    });
                }), b.toggleClass("_active"), c.more.text(c.more.data("alt")).data("alt", d);
            }
            var b = $(this), c = {
                part: $(".js-descbox-part", b),
                more: $(".js-descbox-more", b)
            };
            c.more.on("click", a);
        });
    }(), function() {
        var a = $(".js-product");
        a.each(function() {
            function a() {
                var a = $W.height() - (d.headerHeight + d.footerHeight), c = 0;
                a < d.minArea && (a = d.minArea), b.css("height", a / 10 + "rem"), c = Math.floor((a - d.descBoxHeight) / 2), 
                20 > c && (c = 20), d.isReady || (d.isReady = !0, b.addClass("_ready"));
            }
            var b = $(this), c = {
                descBox: $(".js-descbox", b)
            }, d = {
                footerHeight: $(".l-footer").outerHeight(),
                headerHeight: $(".l-header").outerHeight(),
                descBoxHeight: c.descBox.outerHeight(),
                minArea: 0,
                isReady: !1
            };
            d.minArea = 610 - d.headerHeight, $W.on("resize", a).trigger("resize");
        });
    }(), function() {
        var a = $(".js-fullheight");
        a.each(function() {
            function a() {
                var a = $W.height() - c.footerHeight;
                590 > a && (a = 590), b.height(a / 10 + "rem"), c.isReady || (c.isReady = !0, b.addClass("_ready"));
            }
            var b = $(this), c = {
                footerHeight: 60,
                isReady: !1
            };
            $W.on("resize", a).trigger("resize");
        });
    }(), function() {
        function a() {
            var a = $(this), b = a.closest(".js-marker");
            b.length && b.toggleClass("_active");
        }
        $D.on("click touchend", ".js-marker-close, .js-marker-image", a);
    }(), function() {
        var a = $(".js-market-map");
        a.each(function() {
            function a() {
                i.panTo(k.center), i.setZoom(k.zoom);
            }
            function b() {
                j = new google.maps.LatLngBounds(), $.each(g, function(a, b) {
                    {
                        var c = h.replace("{{ title }}", b.title).replace("{{ content }}", b.content).replace("{{ coords }}", b.coords.join(";")), d = new google.maps.LatLng(b.coords[0], b.coords[1]);
                        new RichMarker({
                            map: i,
                            position: d,
                            draggable: !1,
                            flat: !0,
                            content: c,
                            enableEventPropagation: !0
                        });
                    }
                }), f.mapObject.on("click touchend", ".js-marker-image", function() {
                    var a = $(this), b = a.closest(".js-marker"), c = b.data("coords").split(";"), d = new google.maps.LatLng(c[0], c[1]);
                    f.mapObject.find(".js-marker").not(b).removeClass("_active"), i.panTo(d), i.setZoom(l);
                }).on("click touchend", ".js-marker-close", a);
            }
            function c() {
                function a() {
                    var a = i.getZoom(), f = b.filter("._in"), h = b.filter("._out");
                    b.removeClass("_disabled"), a == d && f.addClass("_disabled"), a == c && h.addClass("_disabled"), 
                    e.toggleClass("_far-zoom", g.indexOf(a) > -1);
                }
                var b = f.zoom.find(".js-map-zoom-button"), c = ~~f.mapObject.data("zoomMin") || 8, d = ~~f.mapObject.data("zoomMax") || 18, g = [ c, c + 1, c + 2 ];
                b.on("click", function() {
                    var a = $(this), b = a.hasClass("_out") ? -1 : 1, c = i.getZoom(), d = c + b;
                    a.hasClass("_disabled") || i.setZoom(d);
                }), a(), google.maps.event.addListener(i, "zoom_changed", a);
            }
            function d() {
                i = f.mapObject.data("map"), k.center = i.getCenter(), k.zoom = i.getZoom(), setTimeout(function() {
                    $(i.getDiv()).find("> DIV").addClass("gm-map-holder");
                }, 100), b(), c(), $W.on("resize", function() {
                    var a = i.getCenter();
                    google.maps.event.trigger(i, "resize"), i.panTo(a);
                });
            }
            var e = $(this), f = {
                mapObject: $(".js-market-map-object", e),
                markerTPL: $(".js-market-map-markertpl", e),
                zoom: $(".js-map-zoom", e)
            }, g = window.G.market.points || [], h = f.markerTPL.html(), i = null, j = null, k = {}, l = 16;
            if (!Modernizr.flexbox) {
                var m = null;
                f.mapObject.append('<div class="market-map-ie"><div class="market-map-ie__nest"></div></div>'), 
                m = f.mapObject.find(".market-map-ie__nest"), m.data(f.mapObject.data()), f.mapObject = m;
            }
            new MakeMap({
                el: f.mapObject,
                zoom: 9
            }).done(d);
        });
    }(), function() {
        var a = $(".js-contacts");
        a.each(function() {
            function a() {
                l = new google.maps.LatLngBounds(), $.each(i, function(a, b) {
                    {
                        var c = j.replace("{{ title }}", b.title).replace("{{ content }}", b.content).replace("{{ coords }}", b.coords.join(";")), d = new google.maps.LatLng(b.coords[0], b.coords[1]);
                        new RichMarker({
                            map: k,
                            position: d,
                            draggable: !1,
                            flat: !0,
                            content: c,
                            enableEventPropagation: !0
                        });
                    }
                    l.extend(d);
                }), h.mapObject.on("click touchend", ".js-marker-close", function(a) {
                    a.stopPropagation(), f();
                });
            }
            function b(a, b, c) {
                var d = Math.pow(2, k.getZoom()), e = (new google.maps.LatLng(k.getBounds().getNorthEast().lat(), k.getBounds().getSouthWest().lng()), 
                k.getProjection().fromLatLngToPoint(a)), f = new google.maps.Point(b / d || 0, c / d || 0), g = new google.maps.Point(e.x - f.x, e.y + f.y), h = k.getProjection().fromPointToLatLng(g);
                k.setCenter(h);
            }
            function c() {
                function a() {
                    var a = k.getZoom();
                    console.info(a);
                    var f = b.filter("._in"), g = b.filter("._out");
                    b.removeClass("_disabled"), a == d && f.addClass("_disabled"), a == c && g.addClass("_disabled"), 
                    h.map.toggleClass("_far-zoom", e.indexOf(a) > -1);
                }
                var b = h.zoom.find(".js-map-zoom-button"), c = ~~h.mapObject.data("zoomMin") || 8, d = ~~h.mapObject.data("zoomMax") || 18, e = [ c, c + 1, c + 2 ];
                b.on("click", function() {
                    var a = $(this), b = a.hasClass("_out") ? -1 : 1, c = k.getZoom(), d = c + b;
                    a.hasClass("_disabled") || k.setZoom(d);
                }), a(), google.maps.event.addListener(k, "zoom_changed", a);
            }
            function d() {
                k = h.mapObject.data("map"), m.center = k.getCenter(), m.zoom = k.getZoom(), setTimeout(function() {
                    $(k.getDiv()).find("> DIV").addClass("gm-map-holder");
                }, 100), h.mapControls.length && (g.before(h.mapControls), h.zoom = h.mapControls.find(".js-map-zoom"), 
                c()), a(), $W.on("resize", function() {
                    var a = k.getCenter();
                    google.maps.event.trigger(k, "resize"), k.panTo(a);
                });
            }
            function e() {
                g.addClass("_show-map"), h.mapControls.addClass("_active"), k && (k.fitBounds(l), 
                k.getZoom() > 15 && (k.setZoom(15), b(k.getCenter(), -105, -100)));
            }
            function f() {
                g.removeClass("_show-map"), h.mapControls.removeClass("_active"), k && (k.panTo(m.center), 
                k.setZoom(m.zoom));
            }
            var g = $(this), h = {
                map: $(".js-contacts-map", g),
                mapObject: $(".js-contacts-map-object", g),
                mapClose: $(".js-contacts-map-close", g),
                markerTPL: $(".js-contacts-map-markertpl", g),
                mapControls: $(".js-contacts-map-controls", g),
                infoShowMap: $(".js-contacts-info-show", g)
            }, i = window.G.contacts.points || [], j = h.markerTPL.html(), k = null, l = null, m = {};
            new MakeMap({
                el: h.mapObject,
                zoom: 14
            }).done(d), h.infoShowMap.on("click", function(a) {
                a.preventDefault(), e();
            }), h.mapClose.on("click", f), $D.on("contacts:map:show", e).on("contacts:map:hide", f);
        });
    }(), function() {
        var a = $(".js-product-table");
        a.each(function() {
            function a(a) {
                var b = a.data("item"), c = d.specs.filter('[data-spec="' + b + '"]');
                d.specs.removeClass("_active"), c.length && c.addClass("_active");
            }
            function b() {
                Modernizr.touch ? d.caro.hide(0).show(0).addClass("_ready") : d.caro.addClass("_ready");
            }
            var c = $(this), d = {
                arrows: $(".js-product-caro-arrow", c),
                caro: $(".js-product-caro", c),
                list: $(".js-product-caro-list", c),
                listItems: $(".js-product-caro-list > LI", c),
                specs: $(".js-product-spec-item", c)
            };
            d.listItems.length > 1 ? (d.caro.addClass("_multiple"), d.list.bxSlider({
                mode: "fade",
                minSlides: 1,
                maxSlides: 1,
                pager: !1,
                slideMargin: 0,
                responsive: !0,
                controls: !0,
                prevSelector: d.arrows.filter("._prev"),
                nextSelector: d.arrows.filter("._next"),
                onSlideBefore: a,
                onSliderLoad: b
            })) : Modernizr.touch ? d.caro.hide(0).show(0).addClass("_single _ready") : d.caro.addClass("_single _ready");
        });
    }();
});